[phases.setup]
nixPkgs = ["python310", "gcc"]

[phases.install]
cmds = [
  "python -m venv --copies /opt/venv",
  ". /opt/venv/bin/activate",
  "pip install --no-cache-dir --upgrade pip",
  # Install semua requirements (ultralytics akan install torch GPU)
  "pip install --no-cache-dir -r requirements.txt",
  # Uninstall torch GPU dan semua CUDA dependencies
  "pip uninstall -y torch torchvision || true",
  "pip uninstall -y nvidia-cudnn-cu12 nvidia-cublas-cu12 nvidia-cusparse-cu12 nvidia-cufft-cu12 nvidia-curand-cu12 nvidia-cusolver-cu12 nvidia-cuda-runtime-cu12 nvidia-cuda-nvrtc-cu12 nvidia-cuda-cupti-cu12 nvidia-nvtx-cu12 nvidia-nvjitlink-cu12 nvidia-nvshmem-cu12 nvidia-nccl-cu12 nvidia-cufile-cu12 nvidia-cusparselt-cu12 triton || true",
  # Install PyTorch CPU-only
  "pip install --no-cache-dir torch==2.0.1+cpu torchvision==0.15.2+cpu --index-url https://download.pytorch.org/whl/cpu"
]

[start]
cmd = "gunicorn --workers 1 --threads 2 --timeout 120 app:app"

