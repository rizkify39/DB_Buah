# nixpacks.toml

[phases.setup]
nixPkgs = ["python310", "gcc", "ffmpeg"]
# Kita tetap request library ini sebagai jaring pengaman
aptPkgs = ["libgl1", "libglib2.0-0"]

[phases.install]
cmds = [
  "python -m venv --copies /opt/venv",
  ". /opt/venv/bin/activate",
  "pip install --no-cache-dir --upgrade pip setuptools wheel",
  
  # 1. Install Torch CPU (Hemat RAM)
  "pip install --no-cache-dir torch==2.0.1+cpu torchvision==0.15.2+cpu --index-url https://download.pytorch.org/whl/cpu",
  
  # 2. Install Requirements (termasuk Ultralytics)
  "pip install --no-cache-dir -r requirements.txt",
  
  # 3. [CRITICAL FIX] Hapus OpenCV biasa yang dibawa oleh Ultralytics
  # Kita paksa uninstall 'opencv-python' biar yang tersisa cuma 'opencv-python-headless'
  "pip uninstall -y opencv-python || true",
  
  # 4. Pastikan Headless terinstall (Re-install force untuk memastikan)
  "pip install --no-cache-dir opencv-python-headless==4.8.0.74",

  # 5. Cleanup sampah NVIDIA
  "pip uninstall -y nvidia-cudnn-cu12 nvidia-cublas-cu12 nvidia-cuda-runtime-cu12 ultralytics-thop 2>/dev/null || true",
  
  # 6. Bersihkan file cache python
  "find /opt/venv -type f -name '*.pyc' -delete"
]

[start]
cmd = "gunicorn --workers 1 --threads 2 --timeout 120 app:app"

[variables]
OPENCV_DISABLE_GUI = "1"
QT_QPA_PLATFORM = "offscreen"
